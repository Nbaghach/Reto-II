---
title: "exploracion_datos"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
```

1) Paquetes y lectura de datos

```{r}
# Instalar una sola vez desde consola si hace falta:

# install.packages(c("tidyverse","readr","scales","here","sf","rnaturalearth","rnaturalearthdata"))

library(tidyverse)
library(readr)
library(scales)
library(here)

# Ruta recomendada (versión limpia)
ruta_net <- here("Datos","Base_de_datos_depurada","migracion_neta_limpio.csv")
# Fallback: si no existe el limpio, usa el base y límpialo al vuelo
if (file.exists(ruta_net)) {
  df_raw <- read_csv(ruta_net, show_col_types = FALSE)
} else {
  df_raw <- read_csv(here("Datos","Base_de_datos_depurada","migracion_neta_por_pais_ano.csv"), 
                     show_col_types = FALSE) %>%
    select(-matches("\\.y$")) %>%
    rename_with(~ sub("\\.x$", "", .x), ends_with(".x")) %>%
    select(-any_of(c("iso3166_2","iso3166_2.x","iso3166_2.y")))
}

glimpse(df_raw)

```

2) Preparación para gráficos

```{r}
df <- df_raw %>%
  transmute(
    geo        = tolower(geo),
    year       = as.integer(year),
    country    = country_name,
    immigrants = as.numeric(immigrant_stock_value),
    emigrants  = as.numeric(emigrant_stock_value),
    net        = as.numeric(net_migration),
    region4    = dplyr::coalesce(.data[["world_4region"]], NA_character_),
    region6    = dplyr::coalesce(.data[["world_6region"]], NA_character_),
    income     = dplyr::coalesce(.data[["income_groups"]], NA_character_)
  ) %>%
  mutate(region = coalesce(region6, region4))

glimpse(df)

fmt_si <- label_number(accuracy = 1, scale_cut = cut_short_scale())
ultimo_anio <- max(df$year, na.rm = TRUE)
```
3) Evolución global (líneas)

```{r}
evol_global <- df %>%
  group_by(year) %>%
  summarise(
    immigrants = sum(immigrants, na.rm = TRUE),
    emigrants  = sum(emigrants,  na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_longer(c(immigrants, emigrants), names_to = "tipo", values_to = "valor")

p_evol <- ggplot(evol_global, aes(year, valor, linetype = tipo)) +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = fmt_si) +
  labs(title = "Evolución global de migrantes internacionales (1990–2019)",
       x = "Año", y = "Personas", linetype = "") +
  theme_minimal()
p_evol
```

4) Histogramas (log)

```{r}
p_hist_imm <- ggplot(df, aes(immigrants)) +
  geom_histogram(bins = 50) +
  scale_x_log10(labels = fmt_si) +
  labs(title = "Distribución de inmigrantes por país–año (log10)",
       x = "Inmigrantes", y = "Frecuencia") +
  theme_minimal()
p_hist_imm

p_hist_emi <- ggplot(df, aes(emigrants)) +
  geom_histogram(bins = 50) +
  scale_x_log10(labels = fmt_si) +
  labs(title = "Distribución de emigrantes por país–año (log10)",
       x = "Emigrantes", y = "Frecuencia") +
  theme_minimal()
p_hist_emi
```

5) Dispersión inmigrantes vs emigrantes (log–lo

```{r}
df_scatter <- df %>% filter(immigrants > 0, emigrants > 0)

p_scatter <- ggplot(df_scatter, aes(immigrants, emigrants)) +
  geom_point(alpha = 0.5) +
  scale_x_log10(labels = fmt_si) +
  scale_y_log10(labels = fmt_si) +
  labs(title = "Relación inmigrantes vs. emigrantes por país–año",
       x = "Inmigrantes (log10)", y = "Emigrantes (log10)") +
  theme_minimal()
p_scatter
```
6) Top 10 países (último año disponible)

```{r}
top_inm <- df %>%
  filter(year == ultimo_anio) %>%
  arrange(desc(immigrants)) %>%
  slice_head(n = 10) %>%
  mutate(country = forcats::fct_reorder(country, immigrants))

p_top_inm <- ggplot(top_inm, aes(x = country, y = immigrants)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = fmt_si) +
  labs(title = paste0("Top 10 países por inmigrantes (", ultimo_anio, ")"),
       x = "", y = "Inmigrantes") +
  theme_minimal()
p_top_inm

top_emi <- df %>%
  filter(year == ultimo_anio) %>%
  arrange(desc(emigrants)) %>%
  slice_head(n = 10) %>%
  mutate(country = forcats::fct_reorder(country, emigrants))

p_top_emi <- ggplot(top_emi, aes(x = country, y = emigrants)) +
  geom_col() +
  coord_flip() +
  scale_y_continuous(labels = fmt_si) +
  labs(title = paste0("Top 10 países por emigrantes (", ultimo_anio, ")"),
       x = "", y = "Emigrantes") +
  theme_minimal()
p_top_emi
```

7) Migración neta: divergente (Top+/Bottom–)

```{r}
net_last <- df %>%
  filter(year == ultimo_anio, !is.na(net)) %>%
  arrange(desc(net))

top_pos <- net_last %>% slice_head(n = 10)
top_neg <- net_last %>% slice_tail(n = 10) %>% arrange(net)

net_div <- bind_rows(top_neg, top_pos) %>%
  mutate(country = forcats::fct_reorder(country, net))

p_net <- ggplot(net_div, aes(x = country, y = net)) +
  geom_col() +
  coord_flip() +
  geom_hline(yintercept = 0) +
  scale_y_continuous(labels = fmt_si) +
  labs(title = paste0("Migración neta (Top + / Bottom –) en ", ultimo_anio),
       x = "", y = "Saldo migratorio (neto)") +
  theme_minimal()
p_net
```
8) Boxplot por nivel de ingresos

```{r}
df_income <- df %>%
  filter(!is.na(income), !is.na(immigrants), immigrants > 0)

p_box_income <- ggplot(df_income, aes(x = income, y = immigrants)) +
  geom_boxplot(outlier.alpha = 0.4) +
  scale_y_log10(labels = fmt_si) +
  labs(title = "Inmigrantes por nivel de ingresos (log10)",
       x = "Nivel de ingresos", y = "Inmigrantes") +
  theme_minimal()
p_box_income
```

9)  Mapa coroplético — Migración neta

```{r}
# Ejecuta estas instalaciones una sola vez desde consola:
# install.packages(c("sf","rnaturalearth","rnaturalearthdata"))

library(sf)
library(rnaturalearth)
library(rnaturalearthdata)

world <- ne_countries(scale = "medium", returnclass = "sf") %>%
  mutate(geo = tolower(iso_a3)) %>%
  select(geo, geometry)

anio_map <- if (any(df$year == 2019, na.rm = TRUE)) 2019 else max(df$year, na.rm = TRUE)

dat_year <- df %>%
  filter(year == anio_map) %>%
  select(geo, country, net)

mapa_year <- world %>% left_join(dat_year, by = "geo")

abs_val <- abs(mapa_year$net)
q <- quantile(abs_val, 0.95, na.rm = TRUE)

ggplot(mapa_year) +
  geom_sf(aes(fill = net), color = "white", size = 0.1) +
  scale_fill_gradient2(
    low = "#b2182b", mid = "white", high = "#2166ac",
    midpoint = 0, limits = c(-q, q), oob = scales::squish,
    labels = label_number(scale_cut = cut_short_scale()),
    name = "Migración neta"
  ) +
  labs(title = paste0("Migración neta en ", anio_map)) +
  theme_minimal()
```

