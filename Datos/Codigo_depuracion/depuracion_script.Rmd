---
title: "Reto 1 modulo 8"
output: html_document
date: "2025-08-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


3.1 Paquetes y rutas del proyecto
```{r}
# Paquetes
if (!requireNamespace("readr", quietly = TRUE)) install.packages("readr")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("here",  quietly = TRUE)) install.packages("here")

library(readr)
library(dplyr)
library(here)

# Rutas relativas (NO usar rutas absolutas)
base    <- here("Datos", "Base_de_datos_original")
out_dir <- here("Datos", "Base_de_datos_depurada")

# Comprobación rápida: archivos esperados en la carpeta original
print(list.files(base))
stopifnot(file.exists(file.path(base, "ddf--entities--geo--country.csv")))
stopifnot(file.exists(file.path(base, "ddf--datapoints--immigrant_stock--by--geo--year.csv")))
stopifnot(file.exists(file.path(base, "ddf--datapoints--emigrant_stock--by--geo--year.csv")))
```

3.2 Importación de datos crudos
```{r}
# Lectura (UTF-8) de los tres CSV originales
entities_geo <- read_csv(file.path(base, "ddf--entities--geo--country.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

immigrant_df <- read_csv(file.path(base, "ddf--datapoints--immigrant_stock--by--geo--year.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

emigrant_df  <- read_csv(file.path(base, "ddf--datapoints--emigrant_stock--by--geo--year.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

# Vistazo
dplyr::glimpse(entities_geo)
dplyr::glimpse(immigrant_df)
dplyr::glimpse(emigrant_df)
```

3.3 Limpieza y estandarización
```{r}
# 1) Detectar clave (geo/country) y columna de nombre legible (name / name:en)
key_col  <- if ("country" %in% names(entities_geo)) "country" else "geo"
name_col <- if ("name" %in% names(entities_geo)) "name" else if ("name:en" %in% names(entities_geo)) "name:en" else NA_character_

# 2) Crear versión de entidades conservando *todas* las columnas originales,
#    añadiendo 'country_name' y una clave unificada 'geo_key' para el join
entities_geo_full <- entities_geo %>%
  mutate(country_name = dplyr::coalesce(.data[[name_col]], as.character(.data[[key_col]]))) %>%
  rename(geo_key = !!key_col)

# 3) Preparar inmigración (conservar todas las columnas originales)
imm <- immigrant_df %>%
  mutate(year = as.integer(year)) %>%
  left_join(entities_geo_full, by = c("geo" = "geo_key")) %>%
  rename(immigrant_stock_value = immigrant_stock)

# 4) Preparar emigración (conservar todas las columnas originales)
emi <- emigrant_df %>%
  mutate(year = as.integer(year)) %>%
  left_join(entities_geo_full, by = c("geo" = "geo_key")) %>%
  rename(emigrant_stock_value = emigrant_stock)

# 5) Guardar intermedios completos (sin perder variables)
readr::write_csv(imm, file.path(out_dir, "immigrant_stock_by_country_year.csv"))
readr::write_csv(emi, file.path(out_dir, "emigrant_stock_by_country_year.csv"))

```

3.4 Cálculo de migración neta y depuración de duplicadas
```{r}
# 6) Unir por geo y year (no unimos por country_name para evitar duplicados innecesarios)
net_mig <- full_join(imm, emi, by = c("geo", "year")) %>%
  mutate(
    immigrant_stock_value = as.numeric(immigrant_stock_value),
    emigrant_stock_value  = as.numeric(emigrant_stock_value),
    net_migration = immigrant_stock_value - emigrant_stock_value
  )

# Guardar versión base (antes de limpiar duplicadas)
readr::write_csv(net_mig, file.path(out_dir, "migracion_neta_por_pais_ano.csv"))

# 7) Eliminar columnas duplicadas *.y, quitar sufijo .x, y eliminar iso3166_2 (si aparece)
net_mig_clean <- net_mig %>%
  select(-matches("\\.y$")) %>%                                   # elimina duplicadas .y
  rename_with(~ sub("\\.x$", "", .x), ends_with(".x")) %>%        # quita sufijo .x en resto
  select(-any_of(c("iso3166_2", "iso3166_2.x", "iso3166_2.y"))) %>% # elimina iso3166_2
  arrange(geo, year)

# Guardar versión limpia definitiva
readr::write_csv(net_mig_clean, file.path(out_dir, "migracion_neta_limpio.csv"))

```

3.5 Registro de salidas
```{r}
message(" Archivos creados en: ", normalizePath(out_dir))
print(list.files(out_dir))
```




