---
title: "Código_depuración"
output: html_document
date: "2025-08-03"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


3.1 Paquetes y rutas del proyecto
```{r}
# Paquetes
if (!requireNamespace("readr", quietly = TRUE)) install.packages("readr")
if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
if (!requireNamespace("here",  quietly = TRUE)) install.packages("here")

library(readr)
library(dplyr)
library(here)

# Rutas relativas
base    <- here("Datos", "Base_de_datos_original")
out_dir <- here("Datos", "Base_de_datos_depurada")

# Comprobación rápida: archivos esperados en la carpeta original
print(list.files(base))
stopifnot(file.exists(file.path(base, "ddf--entities--geo--country.csv")))
stopifnot(file.exists(file.path(base, "ddf--datapoints--immigrant_stock--by--geo--year.csv")))
stopifnot(file.exists(file.path(base, "ddf--datapoints--emigrant_stock--by--geo--year.csv")))
```

3.2 Importación de datos crudos
```{r}
# Lectura (UTF-8) de los CSV originales
entities_geo <- read_csv(file.path(base, "ddf--entities--geo--country.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

immigrant_df <- read_csv(file.path(base, "ddf--datapoints--immigrant_stock--by--geo--year.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

emigrant_df  <- read_csv(file.path(base, "ddf--datapoints--emigrant_stock--by--geo--year.csv"),
                         locale = locale(encoding = "UTF-8"),
                         show_col_types = FALSE)

# Revisión
dplyr::glimpse(entities_geo)
dplyr::glimpse(immigrant_df)
dplyr::glimpse(emigrant_df)
```

3.3 Limpieza y estandarización
```{r}

# 1) Detectar columnas claves (geo/country) y columna de nombre legible (name / name:en)

key_col  <- if ("country" %in% names(entities_geo)) "country" else "geo"
name_col <- if ("name" %in% names(entities_geo)) "name" else if ("name:en" %in% names(entities_geo)) "name:en" else NA_character_

# 2) Estandariza entidades: Crea versión de entidades conservando *todas* las columnas originales, añadiendo 'country_name' y una clave unificada 'geo_key' para el join

entities_geo_full <- entities_geo %>%
  mutate(country_name = dplyr::coalesce(.data[[name_col]], as.character(.data[[key_col]]))) %>%
  rename(geo_key = !!key_col)

# 3) Preparar tabla inmigración (conserva todas las columnas originales)

imm <- immigrant_df %>%
  mutate(year = as.integer(year)) %>%
  left_join(entities_geo_full, by = c("geo" = "geo_key")) %>%
  rename(immigrant_stock_value = immigrant_stock)

# 4) Preparar tabla emigración (conserva todas las columnas originales)

emi <- emigrant_df %>%
  mutate(year = as.integer(year)) %>%
  left_join(entities_geo_full, by = c("geo" = "geo_key")) %>%
  rename(emigrant_stock_value = emigrant_stock)

# 5) Guardar base de datos intermedias 

readr::write_csv(imm, file.path(out_dir, "immigrants.csv"))
readr::write_csv(emi, file.path(out_dir, "emigrants.csv"))

```

3.4 Cálculo de migración neta y depuración de duplicadas
```{r}
# 6) Unir por geo y year 

net_mig <- full_join(imm, emi, by = c("geo", "year")) %>%
  mutate(
    immigrant_stock_value = as.numeric(immigrant_stock_value),
    emigrant_stock_value  = as.numeric(emigrant_stock_value),
    net_migration = immigrant_stock_value - emigrant_stock_value
  )

# Guardar versión base (antes de limpieza)
readr::write_csv(net_mig, file.path(out_dir, "migracion_neta.csv"))

# 7) Eliminar columnas duplicadas y renombrar

net_mig_clean <- net_mig %>%
  dplyr::transmute(
    iso3           = dplyr::coalesce(iso3166_1_alpha3.x, iso3166_1_alpha3.y),
    country_name   = dplyr::coalesce(country_name.x, country_name.y, name.x, name.y),
    year           = year,
    inmigrants    = immigrant_stock_value,
    emigrants     = emigrant_stock_value,
    net_migration  = net_migration,
    region4        = dplyr::coalesce(world_4region.x, world_4region.y),
    region6        = dplyr::coalesce(world_6region.x, world_6region.y),
    income_groups = dplyr::coalesce(income_groups.x, income_groups.y),
    g77_ocde       = dplyr::coalesce(g77_and_oecd_countries.x, g77_and_oecd_countries.y),
    un_state       = dplyr::coalesce(un_state.x, un_state.y),
    landlocked     = dplyr::coalesce(landlocked.x, landlocked.y),
    latitude       = dplyr::coalesce(latitude.x, latitude.y),
    longitude      = dplyr::coalesce(longitude.x, longitude.y),
    religion       = dplyr::coalesce(main_religion_2008.x, main_religion_2008.y)
  ) %>%
  dplyr::arrange(iso3, year)

# Guardar versión limpia definitiva

readr::write_csv(net_mig_clean, file.path(out_dir, "migracion_neta_limpio.csv"))

```

3.5 Registro de salidas
```{r}
message(" Archivos creados en: ", normalizePath(out_dir))
print(list.files(out_dir))
```




